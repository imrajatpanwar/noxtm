# üîí EMAIL SECURITY FIX - URGENT ACTION REQUIRED

## üìß Issue Summary

Your server **185.137.122.61** is experiencing **high SMTP traffic on port 25**. Your hosting provider has warned you about potential compromise and impending port 25 blocking.

### What We Did

‚úÖ **Added Rate Limiting** - Prevents spam by limiting:
  - Verification emails: 3 per hour per email
  - Password reset: 3 per hour per email
  - Invitations: 10 per hour per user
  - Template emails: 50 per hour per user

‚úÖ **Added Email Logging** - All emails are now logged to database with:
  - Sender, recipient, subject, timestamp
  - Status (queued, sent, failed)
  - Error messages if failed
  - User ID and IP address

‚úÖ **Added Email Validation** - Blocks:
  - Invalid email formats
  - Disposable/temporary email domains
  - Suspicious email patterns

‚úÖ **Created Diagnostic Scripts** - To check server security

## üö® IMMEDIATE ACTIONS REQUIRED

### Step 1: Diagnose Your Server (CRITICAL - Do This First!)

#### Option A: Windows (PowerShell)
```powershell
cd c:\exe\noxtm\Backend\scripts
.\check-mail-server-security.ps1
```
This will show you commands to run on your server.

#### Option B: Upload & Run Bash Script
```bash
# Upload the diagnostic script to your server
scp "c:\exe\noxtm\Backend\scripts\check-mail-server-security.sh" root@185.137.122.61:/root/

# SSH into your server
ssh root@185.137.122.61

# Run the diagnostic
chmod +x /root/check-mail-server-security.sh
sudo /root/check-mail-server-security.sh
```

### Step 2: Check Results

**If you see:**
- ‚ùå **>10 active SMTP connections** ‚Üí Server is likely compromised
- ‚ùå **>100 emails in queue** ‚Üí Server is sending spam
- ‚ùå **Open relay detected** ‚Üí Server is misconfigured
- ‚ùå **Suspicious processes** ‚Üí Server may have malware

**Take immediate action:**
```bash
# Stop Postfix immediately
sudo systemctl stop postfix

# Flush mail queue
sudo postsuper -d ALL

# Block port 25 temporarily
sudo iptables -A OUTPUT -p tcp --dport 25 -j DROP
```

### Step 3: Choose SMTP Solution

You have 3 options. We **STRONGLY RECOMMEND Option 2 (External SMTP Service)**.

---

## üìã OPTION 1: Fix Own Mail Server (NOT RECOMMENDED)

**Why NOT recommended:**
- Complex setup required
- Risk of getting blacklisted
- Requires SPF/DKIM/DMARC configuration
- Ongoing maintenance and security patches
- Hosting provider may still block you

**If you still want to do it:**

### 1. Switch from Port 25 to Port 587

Update `.env`:
```bash
# BEFORE (INSECURE):
EMAIL_HOST=185.137.122.61
EMAIL_PORT=25
EMAIL_USER=
EMAIL_PASS=
EMAIL_FROM=noreply@noxtm.com

# AFTER (SECURE):
EMAIL_HOST=185.137.122.61
EMAIL_PORT=587
EMAIL_USER=noreply@noxtm.com
EMAIL_PASS=YourSecurePassword123!
EMAIL_FROM=noreply@noxtm.com
```

### 2. Configure Postfix for Port 587

SSH into your server and run:

```bash
# Edit Postfix master.cf
sudo nano /etc/postfix/master.cf

# Add or uncomment these lines:
submission inet n       -       y       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_tls_auth_only=yes
  -o smtpd_reject_unlisted_recipient=no
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject
  -o smtpd_helo_restrictions=
  -o smtpd_sender_restrictions=
  -o smtpd_recipient_restrictions=
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING

# Configure SASL authentication
sudo apt-get install libsasl2-modules

# Edit main.cf
sudo nano /etc/postfix/main.cf

# Add:
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_tls_cert_file = /etc/ssl/certs/ssl-cert-snakeoil.pem
smtpd_tls_key_file = /etc/ssl/private/ssl-cert-snakeoil.key

# Restart Postfix
sudo systemctl restart postfix

# Test
telnet 185.137.122.61 587
```

### 3. Set Rate Limits in Postfix

```bash
sudo nano /etc/postfix/main.cf

# Add rate limiting:
smtpd_client_connection_count_limit = 10
smtpd_client_message_rate_limit = 100
smtpd_client_recipient_rate_limit = 200

sudo systemctl restart postfix
```

---

## ‚≠ê OPTION 2: Use External SMTP Service (RECOMMENDED)

**Why recommended:**
- ‚úÖ No maintenance required
- ‚úÖ Better deliverability
- ‚úÖ No blacklist risk
- ‚úÖ Built-in monitoring
- ‚úÖ Free tiers available
- ‚úÖ 5 minutes to set up

### Choice A: Mailgun (BEST OPTION)

**Free tier:** 5,000 emails/month for first 3 months, then pay-as-you-go

#### Setup Steps:

1. **Sign up:** https://www.mailgun.com
2. **Add domain:** Domain settings ‚Üí Add noxtm.com
3. **Add DNS records** (in your DNS provider):
   ```
   TXT  noxtm.com  v=spf1 include:mailgun.org ~all
   TXT  mg._domainkey.noxtm.com  [Mailgun will provide]
   CNAME email.noxtm.com  mailgun.org
   ```
4. **Get credentials:**
   - Go to: Sending ‚Üí Domain settings ‚Üí SMTP credentials
   - Username: `postmaster@mg.noxtm.com`
   - Password: [Generated by Mailgun]

5. **Update `.env`:**
   ```bash
   EMAIL_HOST=smtp.mailgun.org
   EMAIL_PORT=587
   EMAIL_USER=postmaster@mg.noxtm.com
   EMAIL_PASS=YourMailgunPassword
   EMAIL_FROM=noreply@noxtm.com
   ```

6. **Test:**
   ```bash
   cd c:\exe\noxtm\Backend
   node test-email.js your-email@example.com
   ```

### Choice B: SendGrid

**Free tier:** 100 emails/day forever

#### Setup Steps:

1. **Sign up:** https://sendgrid.com
2. **Create API Key:**
   - Settings ‚Üí API Keys ‚Üí Create API Key
   - Name: "Noxtm Backend"
   - Permissions: "Mail Send" ‚Üí Full Access
3. **Update `.env`:**
   ```bash
   EMAIL_HOST=smtp.sendgrid.net
   EMAIL_PORT=587
   EMAIL_USER=apikey
   EMAIL_PASS=SG.xxxxxxxxxxxxxxxxxxxxxxxx
   EMAIL_FROM=noreply@noxtm.com
   ```

### Choice C: Zoho Mail

**Free tier:** 5 email accounts, 5GB per account

#### Setup Steps:

1. **Sign up:** https://www.zoho.com/mail
2. **Add domain & verify** via DNS
3. **Create email:** noreply@noxtm.com
4. **Enable SMTP:**
   - Settings ‚Üí Mail Accounts ‚Üí [Your Account] ‚Üí SMTP Settings
   - Enable "Allow less secure apps" or use app password
5. **Update `.env`:**
   ```bash
   EMAIL_HOST=smtp.zoho.com
   EMAIL_PORT=587
   EMAIL_USER=noreply@noxtm.com
   EMAIL_PASS=YourZohoPassword
   EMAIL_FROM=noreply@noxtm.com
   ```

---

## üß™ OPTION 3: Local Testing Only

For development/testing on localhost:

```bash
# Use a fake SMTP server for testing
npm install -g maildev
maildev

# Update .env
EMAIL_HOST=localhost
EMAIL_PORT=1025
EMAIL_USER=
EMAIL_PASS=
EMAIL_FROM=noreply@noxtm.com

# View emails at: http://localhost:1080
```

---

## ‚úÖ After Changing Configuration

### 1. Restart Backend Server

```bash
cd c:\exe\noxtm\Backend
npm start
```

### 2. Test Email Sending

```bash
# Test verification email
node test-email.js your-email@example.com

# Check logs
tail -f server.log | grep -i email
```

### 3. Monitor Email Logs

The backend now logs all emails to the `EmailLog` collection in MongoDB. You can view them via:

```javascript
// In MongoDB shell or Compass
db.emaillogs.find().sort({sentAt: -1}).limit(50)

// Check for failures
db.emaillogs.find({status: 'failed'})

// Check volume
db.emaillogs.aggregate([
  {$match: {sentAt: {$gte: new Date(Date.now() - 3600000)}}},
  {$group: {_id: "$status", count: {$sum: 1}}}
])
```

### 4. Check Rate Limiting is Working

Try to send multiple verification emails quickly:

```bash
# Should fail after 3 attempts
curl -X POST http://localhost:5000/api/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","fullName":"Test","password":"pass123"}'

# Repeat 4+ times, should get rate limit error
```

---

## üìä Monitoring & Alerts

### View Email Statistics

Create an admin endpoint to monitor email usage:

```bash
# GET /api/admin/email-stats
# Returns:
{
  "timeframe": "24h",
  "totalSent": 45,
  "totalFailed": 2,
  "successRate": "95.74%",
  "recentLogs": [...]
}
```

### Set Up Alerts

Configure alerts for:
- More than 100 emails in 1 hour
- More than 10 failed emails in 1 hour
- Unusual recipient patterns

---

## üîê Security Best Practices Going Forward

1. ‚úÖ **Never use port 25** - Always use port 587 or 465
2. ‚úÖ **Always use authentication** - Never leave EMAIL_USER/PASS empty
3. ‚úÖ **Use external SMTP** - Let experts handle deliverability
4. ‚úÖ **Monitor email logs** - Watch for spikes or failures
5. ‚úÖ **Keep rate limits** - Prevent abuse
6. ‚úÖ **Validate emails** - Block disposable/invalid addresses
7. ‚úÖ **Use HTTPS only** - Never send credentials over HTTP
8. ‚úÖ **Rotate passwords** - Change SMTP passwords regularly
9. ‚úÖ **Enable 2FA** - On all admin accounts
10. ‚úÖ **Keep server updated** - Apply security patches

---

## üìû Reply to Hosting Provider

After fixing the issue, reply to your hosting provider with:

```
Dear Support Team,

Thank you for alerting us to the unusual SMTP traffic on server 185.137.122.61.

We have investigated and taken the following actions:

1. ‚úÖ Stopped Postfix and flushed the mail queue
2. ‚úÖ Migrated to external SMTP service (Mailgun/SendGrid)
3. ‚úÖ Implemented rate limiting (max 3 emails/hour for signups)
4. ‚úÖ Added email validation and logging
5. ‚úÖ Blocked port 25 outbound
6. ‚úÖ Reviewed server security (no compromise found)

Our expected email volume is:
- Peak: ~100 emails/day
- Average: ~30 emails/day
- Types: User signups, password resets, team invitations

We are now using [Mailgun/SendGrid] for all outbound email, so port 25 is no longer needed.

Please confirm if you can:
1. Unblock our server if blocked
2. Remove any sending limits
3. Confirm we're in good standing

Thank you for your patience.

Best regards,
[Your Name]
Noxtm Studio Team
```

---

## üÜò Need Help?

**If server is compromised:**
1. Backup your data immediately
2. Take server offline
3. Reinstall from scratch
4. Restore only verified clean data
5. Change all passwords

**If you're stuck:**
1. Check logs: `tail -f /var/log/mail.log`
2. Test connectivity: `telnet smtp.mailgun.org 587`
3. Check credentials: Make sure no typos in .env
4. Restart backend: `npm restart`

**Still not working?**
- Check firewall: `sudo ufw status`
- Check DNS: `nslookup smtp.mailgun.org`
- Check credentials: Test in email client first

---

## üìù Summary

**What changed:**
- ‚úÖ Rate limiting on ALL email endpoints
- ‚úÖ Email validation & disposable domain blocking
- ‚úÖ Complete email logging to database
- ‚úÖ Security diagnostic scripts

**What you MUST do:**
1. Run diagnostic script on server
2. If compromised: Stop Postfix, flush queue, block port 25
3. Switch to external SMTP (Mailgun recommended)
4. Update .env with new credentials
5. Test email sending
6. Reply to hosting provider

**Recommended configuration (.env):**
```bash
EMAIL_HOST=smtp.mailgun.org
EMAIL_PORT=587
EMAIL_USER=postmaster@mg.noxtm.com
EMAIL_PASS=<your-mailgun-password>
EMAIL_FROM=noreply@noxtm.com
```

---

Good luck! üöÄ
